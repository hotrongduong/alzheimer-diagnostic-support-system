<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tải lên Hồ sơ Y tế - Chẩn đoán Alzheimer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        body {
            background-color: #f0f2f5;
        }

        .navbar {
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .upload-container {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            margin-top: 2rem;
        }

        .drop-zone {
            border: 2px dashed #0d6efd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            color: #0d6efd;
            transition: background-color 0.2s;
        }

        .drop-zone.dragover {
            background-color: #e9f0ff;
            cursor: copy;
        }

        .drop-zone i {
            font-size: 40px;
            margin-bottom: 15px;
        }

        .form-section {
            border-left: 3px solid #0d6efd;
            padding-left: 15px;
            margin-bottom: 1.5rem;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fa-solid fa-brain fa-lg text-primary"></i>
                <strong class="ms-2">Hệ hỗ trợ chẩn đoán Alzheimer</strong>
            </a>
        </div>
    </nav>

    <div class="container">
        <div class="upload-container">
            {% if messages %}
            {% for message in messages %}
            <div class="alert {% if message.tags == 'error' %}alert-danger{% else %}alert-success{% endif %}"
                role="alert">
                {{ message }}
            </div>
            {% endfor %}
            {% endif %}

            <form id="uploadForm" method="post" enctype="multipart/form-data" action="{% url 'uploads:upload_page' %}">
                {% csrf_token %}
                <div class="form-section">
                    <label class="form-label fs-5 fw-bold"><i class="fa-solid fa-user-injured"></i> 1. Thông tin Bệnh
                        nhân</label>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="patient_type" id="newPatientRadio"
                            value="new" checked>
                        <label class="form-check-label" for="newPatientRadio">Bệnh nhân mới</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="patient_type" id="existingPatientRadio"
                            value="existing">
                        <label class="form-check-label" for="existingPatientRadio">Bệnh nhân tái khám</label>
                    </div>
                </div>

                <div id="patient-details">
                    <div id="new-patient-fields" class="mb-3">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="fullName" class="form-label">Họ và tên</label>
                                <input type="text" class="form-control" id="fullName" name="full_name"
                                    placeholder="Nguyễn Văn A">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="dob" class="form-label">Ngày sinh</label>
                                <input type="date" class="form-control" id="dob" name="date_of_birth">
                            </div>
                        </div>
                    </div>
                    <div id="existing-patient-fields" class="mb-3" style="display: none;">
                        <label for="patientUUID" class="form-label">Nhập UUID Bệnh nhân</label>
                        <input type="text" class="form-control" id="patientUUID" name="patient_uuid"
                            placeholder="e.g., 123e4567-e89b-12d3-a456-426614174000">
                    </div>
                </div>

                <div class="form-section">
                    <label class="form-label fs-5 fw-bold"><i class="fa-solid fa-folder-open"></i> 2. Chọn Files hoặc
                        Folder</label>
                    <div id="dropZone" class="drop-zone">
                        <i class="fa-solid fa-file-medical"></i>
                        <p>Kéo và thả file/folder vào đây</p>
                        <p class="text-muted">hoặc</p>
                        <div>
                            <button type="button" id="selectFilesBtn" class="btn btn-primary"><i
                                    class="fa-solid fa-file"></i> Chọn Files</button>
                            <button type="button" id="selectFolderBtn" class="btn btn-secondary"><i
                                    class="fa-solid fa-folder"></i> Chọn Folder</button>
                        </div>
                    </div>
                    <input type="file" id="fileInput" name="files" class="d-none" multiple>
                    <input type="file" id="folderInput" name="files" class="d-none" webkitdirectory>
                </div>

                <div class="mb-4">
                    <h6>Các file đã chọn:</h6>
                    <ul id="file-list" class="list-group">
                        <li class="list-group-item text-muted">Chưa có file nào được chọn.</li>
                    </ul>
                </div>

                <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-lg"><i class="fa-solid fa-paper-plane"></i> Bắt đầu
                        Tải lên và Xử lý</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // === Logic hiển thị form bệnh nhân ===
            const newPatientFields = document.getElementById('new-patient-fields');
            const existingPatientFields = document.getElementById('existing-patient-fields');
            document.querySelectorAll('input[name="patient_type"]').forEach(radio => {
                radio.addEventListener('change', function () {
                    if (this.value === 'new') {
                        newPatientFields.style.display = 'block';
                        existingPatientFields.style.display = 'none';
                    } else {
                        newPatientFields.style.display = 'none';
                        existingPatientFields.style.display = 'block';
                    }
                });
            });

            // === Logic upload file ===
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            const folderInput = document.getElementById('folderInput');
            const fileList = document.getElementById('file-list');
            const selectFilesBtn = document.getElementById('selectFilesBtn');
            const selectFolderBtn = document.getElementById('selectFolderBtn');
            selectFilesBtn.addEventListener('click', () => fileInput.click());
            selectFolderBtn.addEventListener('click', () => folderInput.click());
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const dataTransfer = new DataTransfer();
                if (e.dataTransfer.items) {
                    for (let i = 0; i < e.dataTransfer.items.length; i++) {
                        if (e.dataTransfer.items[i].kind === 'file') {
                            dataTransfer.items.add(e.dataTransfer.items[i].getAsFile());
                        }
                    }
                } else {
                    for (let i = 0; i < e.dataTransfer.files.length; i++) {
                        dataTransfer.items.add(e.dataTransfer.files[i]);
                    }
                }
                fileInput.files = dataTransfer.files;
                folderInput.value = '';
                updateFileList(fileInput.files);
            });
            fileInput.addEventListener('change', () => { folderInput.value = ''; updateFileList(fileInput.files); });
            folderInput.addEventListener('change', () => { fileInput.value = ''; updateFileList(folderInput.files); });
            function updateFileList(files) {
                fileList.innerHTML = '';
                if (!files || files.length === 0) {
                    fileList.innerHTML = '<li class="list-group-item text-muted">Chưa có file nào được chọn.</li>';
                    return;
                }
                for (const file of files) {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.textContent = file.webkitRelativePath || file.name;
                    fileList.appendChild(li);
                }
            }

            // === Logic Xử lý submit form và hiển thị lỗi chi tiết ===
            const uploadForm = document.getElementById('uploadForm');
            const submitButton = uploadForm.querySelector('button[type="submit"]');

            uploadForm.addEventListener('submit', function (event) {
                event.preventDefault();
                submitButton.disabled = true;
                submitButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang tải lên...`;

                const formData = new FormData(uploadForm);

                fetch(uploadForm.action, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken') },
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(errData => {
                                throw new Error(errData.message || 'Lỗi không xác định.');
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === 'processing' && data.session_id) {
                            pollForStudyStatus(data.session_id);
                            submitButton.innerHTML = `<i class="fa-solid fa-cogs"></i> Đang xử lý...`;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Lỗi: ' + error.message);
                        resetSubmitButton();
                    });
            });

            function pollForStudyStatus(sessionId) {
                const pollInterval = 3000;
                const maxAttempts = 20;
                let attempts = 0;
                const intervalId = setInterval(() => {
                    if (attempts >= maxAttempts) {
                        clearInterval(intervalId);
                        alert('Tác vụ xử lý mất quá nhiều thời gian. Vui lòng kiểm tra lại sau.');
                        resetSubmitButton();
                        return;
                    }
                    fetch(`/uploads/status/${sessionId}/`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'COMPLETED') {
                                clearInterval(intervalId);
                                submitButton.innerHTML = `<i class="fa-solid fa-check"></i> Hoàn tất! Đang chuyển hướng...`;
                                const ohifViewerUrl = `http://localhost:3000/segmentation?StudyInstanceUIDs=${data.study_instance_uid}`;
                                window.location.href = ohifViewerUrl;
                            }
                        })
                        .catch(error => {
                            console.error('Polling error:', error);
                            clearInterval(intervalId);
                            alert('Lỗi khi kiểm tra trạng thái xử lý.');
                            resetSubmitButton();
                        });
                    attempts++;
                }, pollInterval);
            }

            function resetSubmitButton() {
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Bắt đầu Tải lên và Xử lý';
            }
        });
    </script>
</body>

</html>